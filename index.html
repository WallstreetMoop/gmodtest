<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMod Stream Controller</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .code-block {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: #1e293b;
            border: 1px solid #334155;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [input, setInput] = useState("");
            const [lastCode, setLastCode] = useState("");
            const [status, setStatus] = useState("idle"); // idle, generating, queuing, success, error
            const [statusMsg, setStatusMsg] = useState("Ready for input");
            const [logs, setLogs] = useState([]);

            const addLog = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [{ time: timestamp, msg, type }, ...prev]);
            };

            const handleSend = async () => {
                if (!input.trim()) return;

                const currentRequest = input;
                setInput(""); // Clear input immediately
                setStatus("generating");
                setStatusMsg("Asking AI to generate code...");
                addLog(`Processing request: "${currentRequest}"`, 'info');

                try {
                    // Step 1: Generate Code via Netlify Function (OpenRouter Proxy)
                    const genResponse = await fetch('/.netlify/functions/generate-lua-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: currentRequest })
                    });

                    if (!genResponse.ok) {
                        throw new Error(`Generation failed: ${genResponse.statusText}`);
                    }

                    const genData = await genResponse.json();
                    
                    // Handle case where function returns { code: "..." } or just the text
                    const luaCode = genData.code || genData.text || genData;
                    
                    if (!luaCode || typeof luaCode !== 'string') {
                        throw new Error("Invalid response format from generator");
                    }

                    setLastCode(luaCode);
                    addLog("Code generated successfully.", 'success');

                    // Step 2: Queue Code via Netlify Function (Database/KV)
                    setStatus("queuing");
                    setStatusMsg("Sending code to GMod Server...");
                    
                    const queueResponse = await fetch('/.netlify/functions/command-queue', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: luaCode })
                    });

                    if (!queueResponse.ok) {
                        throw new Error(`Queueing failed: ${queueResponse.statusText}`);
                    }

                    setStatus("success");
                    setStatusMsg("Command sent to game!");
                    addLog("Code queued for execution.", 'success');
                    
                    // Reset status after a delay
                    setTimeout(() => {
                        setStatus("idle");
                        setStatusMsg("Ready for input");
                    }, 3000);

                } catch (err) {
                    console.error(err);
                    setStatus("error");
                    setStatusMsg("Error: " + err.message);
                    addLog(err.message, 'error');
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-start p-6">
                    <header className="w-full max-w-4xl mb-8 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                                <i className="fa-solid fa-gamepad text-2xl text-white"></i>
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold tracking-tight">GMod Stream Controller</h1>
                                <p className="text-slate-400 text-sm">AI Director &bull; Connected</p>
                            </div>
                        </div>
                        <div className={`px-4 py-2 rounded-full text-xs font-semibold uppercase tracking-wider ${
                            status === 'error' ? 'bg-red-500/20 text-red-400' :
                            status === 'success' ? 'bg-green-500/20 text-green-400' :
                            status !== 'idle' ? 'bg-blue-500/20 text-blue-400 animate-pulse' :
                            'bg-slate-800 text-slate-400'
                        }`}>
                            {statusMsg}
                        </div>
                    </header>

                    <main className="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* Left Column: Input & Controls */}
                        <div className="lg:col-span-2 space-y-6">
                            
                            {/* Input Area */}
                            <div className="bg-slate-800/50 p-1 rounded-xl border border-slate-700 shadow-xl backdrop-blur-sm">
                                <textarea 
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    placeholder="Type a scenario (e.g., 'Spawn a zombie horde behind the player', 'Give the player low gravity')..."
                                    className="w-full h-32 bg-slate-900/80 text-white p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50 resize-none placeholder-slate-500"
                                ></textarea>
                                <div className="flex justify-end p-2">
                                    <button 
                                        onClick={handleSend}
                                        disabled={status !== 'idle' && status !== 'error' && status !== 'success'}
                                        className={`px-6 py-2 rounded-lg font-semibold transition-all duration-200 flex items-center gap-2 ${
                                            status === 'generating' || status === 'queuing' 
                                            ? 'bg-slate-700 text-slate-400 cursor-not-allowed'
                                            : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/20 active:scale-95'
                                        }`}
                                    >
                                        {status === 'generating' ? <i className="fa-solid fa-circle-notch fa-spin"></i> : 
                                         status === 'queuing' ? <i className="fa-solid fa-cloud-arrow-up fa-fade"></i> :
                                         <i className="fa-solid fa-paper-plane"></i>}
                                        {status === 'generating' ? 'Generating...' : 
                                         status === 'queuing' ? 'Sending...' : 'Send Command'}
                                    </button>
                                </div>
                            </div>

                            {/* Last Generated Code View */}
                            <div className="bg-slate-800/30 rounded-xl border border-slate-700 overflow-hidden">
                                <div className="px-4 py-3 bg-slate-800/80 border-b border-slate-700 flex justify-between items-center">
                                    <span className="text-xs font-semibold text-slate-400 uppercase">Last Generated Lua</span>
                                    <button 
                                        onClick={() => {navigator.clipboard.writeText(lastCode)}}
                                        className="text-slate-500 hover:text-white transition-colors text-xs"
                                        title="Copy to Clipboard"
                                    >
                                        <i className="fa-regular fa-copy"></i> Copy
                                    </button>
                                </div>
                                <div className="p-4 overflow-x-auto">
                                    <pre className="text-sm text-green-400 font-mono whitespace-pre-wrap">{lastCode || "// No code generated yet..."}</pre>
                                </div>
                            </div>
                        </div>

                        {/* Right Column: Activity Log */}
                        <div className="lg:col-span-1">
                            <div className="bg-slate-800/30 rounded-xl border border-slate-700 h-full flex flex-col max-h-[600px]">
                                <div className="px-4 py-3 bg-slate-800/80 border-b border-slate-700">
                                    <span className="text-xs font-semibold text-slate-400 uppercase">System Logs</span>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1 space-y-3 custom-scrollbar">
                                    {logs.length === 0 && (
                                        <div className="text-center text-slate-600 text-sm py-10">
                                            No activity recorded
                                        </div>
                                    )}
                                    {logs.map((log, idx) => (
                                        <div key={idx} className="flex gap-3 text-sm animate-fade-in">
                                            <span className="text-slate-500 text-xs font-mono pt-1">{log.time}</span>
                                            <span className={`${
                                                log.type === 'error' ? 'text-red-400' : 
                                                log.type === 'success' ? 'text-green-400' : 
                                                'text-slate-300'
                                            }`}>
                                                {log.msg}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
